
<div class="otd-railcar-window otd-hidden" id="otd-railcar" role="dialog" aria-label="Waggon">
    <div class="otd-railcar-titlebar" data-drag-handle="true">
        <span class="otd-railcar-title">Waggon</span>
        <div class="otd-railcar-title-actions">
            <span class="otd-railcar-status" id="otd-railcar-status">Bereit</span>
            <button class="otd-railcar-close" type="button" aria-label="Schliessen" onclick="closeWaggonFenster();">X</button>
        </div>
    </div>
    <div class="otd-railcar-body">
        <div class="otd-railcar-form">
            <div class="otd-railcar-tabs" role="tablist" aria-label="Waggon Bereiche">
                <button type="button" class="otd-railcar-tab" data-tab="overview">Uebersicht</button>
                <button type="button" class="otd-railcar-tab is-active" data-tab="general">Allgemein</button>
                <button type="button" class="otd-railcar-tab" data-tab="interface">Schnittstelle</button>
                <button type="button" class="otd-railcar-tab" data-tab="functions">Funktionen</button>
                <button type="button" class="otd-railcar-tab" data-tab="details">Einzelheiten</button>
            </div>

            <div class="otd-railcar-tabpanel" data-tab="overview">
                <div class="otd-railcar-section">
                    <div class="otd-railcar-section-title">Uebersicht</div>
                    <div class="otd-railcar-overview">
                        Waehle rechts einen Waggon oder lege einen neuen an. Speichern schreibt direkt nach railcar.xml.
                        <ul class="otd-railcar-overview-list">
                            <li>Allgemein: Grunddaten und Modellangaben.</li>
                            <li>Schnittstelle: Decoder-Protokoll und Adresse.</li>
                            <li>Funktionen: Funktionstabelle mit Zuordnung.</li>
                            <li>Einzelheiten: Betrieb und Service-Historie.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="otd-railcar-tabpanel is-active" data-tab="general">
                <div class="otd-railcar-section">
                    <div class="otd-railcar-section-title">Grunddaten</div>
                    <div class="otd-railcar-grid">
                        <label>
                            UID
                            <input type="text" id="railcar-uid" maxlength="64" />
                        </label>
                        <label>
                            Name
                            <input type="text" id="railcar-name" maxlength="32" />
                        </label>
                        <label>
                            Length (cm)
                            <input type="number" id="railcar-length" min="0" max="200" />
                        </label>
                        <label>
                            Axles
                            <input type="number" id="railcar-axles" min="0" max="32" />
                        </label>
                        <label>
                            Index
                            <input type="number" id="railcar-index" min="0" max="999" />
                        </label>
                    </div>
                </div>

                <div class="otd-railcar-section">
                    <div class="otd-railcar-section-title">Model</div>
                    <div class="otd-railcar-grid otd-railcar-grid-wide">
                        <label>
                            Manufacturer
                            <input type="text" id="railcar-model-manufacturer" maxlength="64" />
                        </label>
                        <label>
                            Scale
                            <select id="railcar-model-scale">
                                <option value=""></option>
                                <option value="H0">H0</option>
                                <option value="N">N</option>
                                <option value="TT">TT</option>
                                <option value="0">0</option>
                                <option value="G">G</option>
                            </select>
                        </label>
                        <label>
                            Catalog number
                            <input type="text" id="railcar-model-catalog" maxlength="64" />
                        </label>
                        <label class="otd-railcar-span-2">
                            Description
                            <textarea id="railcar-model-description" rows="2" maxlength="240"></textarea>
                        </label>
                        <label>
                            Operator
                            <input type="text" id="railcar-model-operator" maxlength="64" />
                        </label>
                        <label>
                            Class
                            <input type="text" id="railcar-model-class" maxlength="64" />
                        </label>
                        <label>
                            Fleet number
                            <input type="text" id="railcar-model-fleet" maxlength="64" />
                        </label>
                        <label>
                            Car type
                            <select id="railcar-model-cartype">
                                <option value=""></option>
                                <option value="coach">coach</option>
                                <option value="freight">freight</option>
                                <option value="control">control</option>
                                <option value="service">service</option>
                            </select>
                        </label>
                        <label>
                            Weight empty (t)
                            <input type="number" id="railcar-model-weight-empty" min="0" step="0.1" />
                        </label>
                        <label>
                            Weight full (t)
                            <input type="number" id="railcar-model-weight-full" min="0" step="0.1" />
                        </label>
                        <label>
                            Vmax (km/h)
                            <input type="number" id="railcar-model-vmax" min="0" step="1" />
                        </label>
                        <label class="otd-railcar-span-2">
                            Image
                            <input type="text" id="railcar-model-image" maxlength="128" />
                        </label>
                        <label class="otd-railcar-span-2">
                            Notes
                            <textarea id="railcar-model-notes" rows="2" maxlength="240"></textarea>
                        </label>
                    </div>
                </div>
            </div>

            <div class="otd-railcar-tabpanel" data-tab="interface">
                <div class="otd-railcar-section">
                    <div class="otd-railcar-section-title">Decoder</div>
                    <div class="otd-railcar-grid">
                        <label>
                            Protocol
                            <select id="railcar-decoder-protocol">
                                <option value=""></option>
                                <option value="DCC128">DCC128</option>
                                <option value="DCC28">DCC28</option>
                                <option value="DCC14">DCC14</option>
                                <option value="MM1">MM1</option>
                                <option value="MM2">MM2</option>
                            </select>
                        </label>
                        <label>
                            Address
                            <input type="number" id="railcar-decoder-address" min="1" max="9999" />
                        </label>
                        <label>
                            Address type
                            <select id="railcar-decoder-addresstype">
                                <option value=""></option>
                                <option value="short">short</option>
                                <option value="long">long</option>
                            </select>
                        </label>
                    </div>
                </div>
            </div>

            <div class="otd-railcar-tabpanel" data-tab="functions">
                <div class="otd-railcar-section">
                    <div class="otd-railcar-section-title">Funktionen</div>
                    <div class="otd-railcar-subtitle">Function table</div>
                    <div class="otd-railcar-table-wrap">
                        <table class="otd-railcar-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Description</th>
                                    <th>Actuation</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Visible</th>
                                    <th>Image</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="railcar-function-rows"></tbody>
                        </table>
                    </div>
                    <div class="otd-railcar-table-actions">
                        <button type="button" id="railcar-function-add">Funktion hinzufuegen</button>
                    </div>
                </div>
            </div>

            <div class="otd-railcar-tabpanel" data-tab="details">
                <div class="otd-railcar-section">
                    <div class="otd-railcar-section-title">Operation</div>
                    <div class="otd-railcar-grid otd-railcar-grid-wide">
                        <label>
                            Purchase date
                            <input type="date" id="railcar-operation-purchasedate" />
                        </label>
                        <label>
                            Operating time
                            <input type="number" id="railcar-operation-operating" min="0" step="0.1" />
                        </label>
                        <label>
                            Travel distance
                            <input type="number" id="railcar-operation-travel" min="0" step="0.1" />
                        </label>
                        <label>
                            Service interval
                            <input type="number" id="railcar-operation-serviceinterval" min="0" step="0.1" />
                        </label>
                    </div>
                    <div class="otd-railcar-subtitle">Service table</div>
                    <div class="otd-railcar-issues" id="railcar-service-issues"></div>
                    <div class="otd-railcar-table-actions">
                        <button type="button" id="railcar-service-add">Service-Eintrag hinzufuegen</button>
                    </div>
                </div>
            </div>

            <div class="otd-railcar-buttons">
                <button type="button" id="railcar-new">Neu</button>
                <button type="button" id="railcar-add">Hinzufuegen / Aktualisieren</button>
                <button type="button" id="railcar-delete">Loeschen</button>
                <button type="button" id="railcar-save">Speichern</button>
            </div>
        </div>
        <div class="otd-railcar-list">
            <div class="otd-railcar-list-head">
                <span>Vorhandene Waggons</span>
                <button type="button" id="railcar-reload">Aktualisieren</button>
            </div>
            <div class="otd-railcar-list-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>UID</th>
                            <th>Length</th>
                            <th>Axles</th>
                            <th>Vmax</th>
                            <th>Address</th>
                            <th>Notes</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="railcar-rows"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Waggon Fenster ---
    (function railcarEditor() {
        const panel = document.getElementById('otd-railcar');
        if (!panel) return;

        const statusEl = document.getElementById('otd-railcar-status');
        const uidInput = document.getElementById('railcar-uid');
        const nameInput = document.getElementById('railcar-name');
        const lengthInput = document.getElementById('railcar-length');
        const axlesInput = document.getElementById('railcar-axles');
        const indexInput = document.getElementById('railcar-index');

        const modelManufacturerInput = document.getElementById('railcar-model-manufacturer');
        const modelScaleSelect = document.getElementById('railcar-model-scale');
        const modelCatalogInput = document.getElementById('railcar-model-catalog');
        const modelDescriptionInput = document.getElementById('railcar-model-description');
        const modelOperatorInput = document.getElementById('railcar-model-operator');
        const modelClassInput = document.getElementById('railcar-model-class');
        const modelFleetInput = document.getElementById('railcar-model-fleet');
        const modelCarTypeSelect = document.getElementById('railcar-model-cartype');
        const modelWeightEmptyInput = document.getElementById('railcar-model-weight-empty');
        const modelWeightFullInput = document.getElementById('railcar-model-weight-full');
        const modelVmaxInput = document.getElementById('railcar-model-vmax');
        const modelImageInput = document.getElementById('railcar-model-image');
        const modelNotesInput = document.getElementById('railcar-model-notes');

        const decoderProtocolSelect = document.getElementById('railcar-decoder-protocol');
        const decoderAddressInput = document.getElementById('railcar-decoder-address');
        const decoderAddressTypeSelect = document.getElementById('railcar-decoder-addresstype');
        const functionRows = document.getElementById('railcar-function-rows');
        const functionAddBtn = document.getElementById('railcar-function-add');
        const serviceIssues = document.getElementById('railcar-service-issues');
        const serviceAddBtn = document.getElementById('railcar-service-add');
        const tabButtons = panel.querySelectorAll('.otd-railcar-tab');
        const tabPanels = panel.querySelectorAll('.otd-railcar-tabpanel');

        const rowsBody = document.getElementById('railcar-rows');
        const addBtn = document.getElementById('railcar-add');
        const newBtn = document.getElementById('railcar-new');
        const deleteBtn = document.getElementById('railcar-delete');
        const saveBtn = document.getElementById('railcar-save');
        const reloadBtn = document.getElementById('railcar-reload');

        const state = {
            items: [],
            selectedId: null,
            loadedOnce: false
        };

        function setStatus(text) {
            if (statusEl) statusEl.textContent = text;
        }

        function setActiveTab(tabKey) {
            tabButtons.forEach(btn => {
                const active = btn.dataset.tab === tabKey;
                btn.classList.toggle('is-active', active);
                btn.setAttribute('aria-selected', active ? 'true' : 'false');
            });
            tabPanels.forEach(panelEl => {
                const active = panelEl.dataset.tab === tabKey;
                panelEl.classList.toggle('is-active', active);
                panelEl.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
        }

        function ensureSelectValue(select, value) {
            if (!select) return;
            const normalized = value ?? '';
            const has = Array.from(select.options).some(option => option.value === normalized);
            if (!has && normalized !== '') {
                const option = document.createElement('option');
                option.value = normalized;
                option.textContent = normalized;
                select.appendChild(option);
            }
            select.value = normalized;
        }

        function resetForm() {
            uidInput.value = '';
            nameInput.value = '';
            lengthInput.value = '';
            axlesInput.value = '';
            indexInput.value = '';

            modelManufacturerInput.value = '';
            ensureSelectValue(modelScaleSelect, '');
            modelCatalogInput.value = '';
            modelDescriptionInput.value = '';
            modelOperatorInput.value = '';
            modelClassInput.value = '';
            modelFleetInput.value = '';
            ensureSelectValue(modelCarTypeSelect, '');
            modelWeightEmptyInput.value = '';
            modelWeightFullInput.value = '';
            modelVmaxInput.value = '';
            modelImageInput.value = '';
            modelNotesInput.value = '';

            ensureSelectValue(decoderProtocolSelect, '');
            decoderAddressInput.value = '';
            ensureSelectValue(decoderAddressTypeSelect, '');

            functionRows.innerHTML = '';
            serviceIssues.innerHTML = '';

            state.selectedId = null;
            addBtn.textContent = 'Hinzufuegen / Aktualisieren';
        }

        function renderList() {
            rowsBody.innerHTML = '';
            for (const item of state.items) {
                const tr = document.createElement('tr');
                const vmax = item.model?.vmax ?? '';
                const address = item.decoder?.address ?? '';
                const notes = item.model?.notes ?? '';
                tr.innerHTML = `
                    <td>${item.name ?? ''}</td>
                    <td>${item.uid ?? ''}</td>
                    <td>${item.length ?? ''}</td>
                    <td>${item.axles ?? ''}</td>
                    <td>${vmax}</td>
                    <td>${address}</td>
                    <td>${notes}</td>
                    <td class="otd-railcar-actions-cell">
                        <button type="button" data-id="${item.uid}" class="otd-railcar-row-edit">Bearbeiten</button>
                        <button type="button" data-id="${item.uid}" class="otd-railcar-row-delete">Entfernen</button>
                    </td>
                `;
                tr.dataset.id = item.uid ?? '';
                tr.draggable = true;
                rowsBody.appendChild(tr);
            }
        }
        function createFunctionRow(item = {}) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="number" min="0" max="99" class="otd-railcar-input-small" /></td>
                <td><input type="text" class="otd-railcar-input-wide" /></td>
                <td><input type="text" class="otd-railcar-input-medium" /></td>
                <td><input type="text" class="otd-railcar-input-medium" /></td>
                <td><input type="text" class="otd-railcar-input-medium" /></td>
                <td>
                    <select class="otd-railcar-input-small">
                        <option value=""></option>
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </td>
                <td><input type="text" class="otd-railcar-input-medium" /></td>
                <td><button type="button" class="otd-railcar-row-remove">X</button></td>
            `;
            const inputs = tr.querySelectorAll('input');
            const select = tr.querySelector('select');
            inputs[0].value = item.no ?? '';
            inputs[1].value = item.description ?? '';
            inputs[2].value = item.actuation ?? '';
            inputs[3].value = item.type ?? '';
            inputs[4].value = item.category ?? '';
            inputs[5].value = item.image ?? '';
            ensureSelectValue(select, item.visible ?? '');
            tr.querySelector('.otd-railcar-row-remove')?.addEventListener('click', () => tr.remove());
            return tr;
        }

        function createServiceIssue(issue = {}) {
            const wrapper = document.createElement('div');
            wrapper.className = 'otd-railcar-issue';
            wrapper.innerHTML = `
                <div class="otd-railcar-issue-head">
                    <label>
                        Date
                        <input type="date" class="otd-railcar-issue-date" />
                    </label>
                    <label>
                        Type
                        <input type="text" class="otd-railcar-issue-type" maxlength="32" />
                    </label>
                    <button type="button" class="otd-railcar-row-remove">X</button>
                </div>
                <label class="otd-railcar-issue-items">
                    Items (eine Zeile pro Eintrag)
                    <textarea rows="3" class="otd-railcar-issue-text"></textarea>
                </label>
            `;
            const dateInput = wrapper.querySelector('.otd-railcar-issue-date');
            const typeInput = wrapper.querySelector('.otd-railcar-issue-type');
            const textArea = wrapper.querySelector('.otd-railcar-issue-text');
            dateInput.value = issue.date ?? '';
            typeInput.value = issue.type ?? '';
            textArea.value = (issue.items ?? []).join('\n');
            wrapper.querySelector('.otd-railcar-row-remove')?.addEventListener('click', () => wrapper.remove());
            return wrapper;
        }

        function fillForm(item) {
            uidInput.value = item.uid ?? '';
            nameInput.value = item.name ?? '';
            lengthInput.value = item.length ?? '';
            axlesInput.value = item.axles ?? '';
            indexInput.value = item.index ?? '';

            const model = item.model ?? {};
            modelManufacturerInput.value = model.manufacturer ?? '';
            ensureSelectValue(modelScaleSelect, model.scale ?? '');
            modelCatalogInput.value = model.catalogNumber ?? '';
            modelDescriptionInput.value = model.description ?? '';
            modelOperatorInput.value = model.operator ?? '';
            modelClassInput.value = model.className ?? '';
            modelFleetInput.value = model.fleetNumber ?? '';
            ensureSelectValue(modelCarTypeSelect, model.carType ?? '');
            modelWeightEmptyInput.value = model.weightEmpty ?? '';
            modelWeightFullInput.value = model.weightFull ?? '';
            modelVmaxInput.value = model.vmax ?? '';
            modelImageInput.value = model.image ?? '';
            modelNotesInput.value = model.notes ?? '';

            const decoder = item.decoder ?? {};
            ensureSelectValue(decoderProtocolSelect, decoder.protocol ?? '');
            decoderAddressInput.value = decoder.address ?? '';
            ensureSelectValue(decoderAddressTypeSelect, decoder.addressType ?? '');

            functionRows.innerHTML = '';
            (decoder.functions ?? []).forEach(fn => functionRows.appendChild(createFunctionRow(fn)));

            const operation = item.operation ?? {};
            document.getElementById('railcar-operation-purchasedate').value = operation.purchaseDate ?? '';
            document.getElementById('railcar-operation-operating').value = operation.operatingTime ?? '';
            document.getElementById('railcar-operation-travel').value = operation.travelDistance ?? '';
            document.getElementById('railcar-operation-serviceinterval').value = operation.serviceInterval ?? '';

            serviceIssues.innerHTML = '';
            (operation.serviceIssues ?? []).forEach(issue => serviceIssues.appendChild(createServiceIssue(issue)));

            state.selectedId = item.uid;
            addBtn.textContent = 'Aktualisieren';
        }

        function collectFunctionRows() {
            const rows = Array.from(functionRows.querySelectorAll('tr'));
            return rows.map(row => {
                const inputs = row.querySelectorAll('input');
                const visibleSelect = row.querySelector('select');
                return {
                    no: inputs[0]?.value.trim() ?? '',
                    description: inputs[1]?.value.trim() ?? '',
                    actuation: inputs[2]?.value.trim() ?? '',
                    type: inputs[3]?.value.trim() ?? '',
                    category: inputs[4]?.value.trim() ?? '',
                    visible: visibleSelect?.value ?? '',
                    image: inputs[5]?.value.trim() ?? ''
                };
            }).filter(fn => Object.values(fn).some(value => value !== ''));
        }

        function collectServiceIssues() {
            const issues = Array.from(serviceIssues.querySelectorAll('.otd-railcar-issue'));
            return issues.map(wrapper => {
                const date = wrapper.querySelector('.otd-railcar-issue-date')?.value.trim() ?? '';
                const type = wrapper.querySelector('.otd-railcar-issue-type')?.value.trim() ?? '';
                const text = wrapper.querySelector('.otd-railcar-issue-text')?.value ?? '';
                const items = text.split('\n').map(line => line.trim()).filter(line => line !== '');
                return { date, type, items };
            }).filter(issue => issue.date !== '' || issue.type !== '' || issue.items.length > 0);
        }

        async function loadFromServer() {
            try {
                setStatus('Laden ...');
                const resp = await fetch('/railcar.xml', { cache: 'no-store' });
                if (!resp.ok) {
                    state.items = [];
                    renderList();
                    setStatus('Keine railcar.xml gefunden - neue Datei anlegen');
                    state.loadedOnce = true;
                    return;
                }
                const xml = await resp.text();
                const doc = new DOMParser().parseFromString(xml, 'application/xml');
                const list = [];
                doc.querySelectorAll('railcars > railcar').forEach(node => {
                    const modelNode = node.querySelector('model');
                    const decoderNode = node.querySelector('decoder');
                    const operationNode = node.querySelector('operation');

                    const functions = [];
                    decoderNode?.querySelectorAll('functiontable > function').forEach(fn => {
                        functions.push({
                            no: fn.getAttribute('no') ?? '',
                            description: fn.getAttribute('description') ?? '',
                            actuation: fn.getAttribute('actuation') ?? '',
                            type: fn.getAttribute('type') ?? '',
                            category: fn.getAttribute('category') ?? '',
                            visible: fn.getAttribute('visible') ?? '',
                            image: fn.getAttribute('image') ?? ''
                        });
                    });

                    const serviceIssuesList = [];
                    operationNode?.querySelectorAll('servicetable > issue').forEach(issue => {
                        const items = [];
                        issue.querySelectorAll('item').forEach(item => {
                            items.push(item.textContent ?? '');
                        });
                        serviceIssuesList.push({
                            date: issue.getAttribute('date') ?? '',
                            type: issue.getAttribute('type') ?? '',
                            items
                        });
                    });

                    list.push({
                        uid: node.getAttribute('uid') || crypto.randomUUID(),
                        name: node.getAttribute('name') ?? '',
                        length: node.getAttribute('length') ?? '',
                        axles: node.getAttribute('axles') ?? '',
                        index: node.getAttribute('index') ?? '',
                        model: {
                            manufacturer: modelNode?.getAttribute('manufacturer') ?? '',
                            scale: modelNode?.getAttribute('scale') ?? '',
                            catalogNumber: modelNode?.getAttribute('catalognumber') ?? '',
                            description: modelNode?.querySelector('description')?.textContent ?? '',
                            operator: modelNode?.querySelector('operator')?.textContent ?? '',
                            className: modelNode?.querySelector('class')?.textContent ?? '',
                            fleetNumber: modelNode?.querySelector('fleetnumber')?.textContent ?? '',
                            carType: modelNode?.querySelector('cartype')?.textContent ?? '',
                            weightEmpty: modelNode?.querySelector('weight_empty')?.textContent ?? '',
                            weightFull: modelNode?.querySelector('weight_full')?.textContent ?? '',
                            vmax: modelNode?.querySelector('vmax')?.textContent ?? '',
                            image: modelNode?.querySelector('image')?.textContent ?? '',
                            notes: modelNode?.querySelector('notes')?.textContent ?? ''
                        },
                        decoder: {
                            protocol: decoderNode?.querySelector('protocol')?.textContent ?? '',
                            address: decoderNode?.querySelector('address')?.textContent ?? '',
                            addressType: decoderNode?.querySelector('addresstype')?.textContent ?? '',
                            functions
                        },
                        operation: {
                            purchaseDate: operationNode?.querySelector('purchasedate')?.textContent ?? '',
                            operatingTime: operationNode?.querySelector('operatingtime')?.textContent ?? '',
                            travelDistance: operationNode?.querySelector('traveldistance')?.textContent ?? '',
                            serviceInterval: operationNode?.querySelector('serviceinterval')?.textContent ?? '',
                            serviceIssues: serviceIssuesList
                        }
                    });
                });
                state.items = list;
                renderList();
                setStatus(`Geladen (${list.length} Eintraege)`);
                state.loadedOnce = true;
            } catch (err) {
                setStatus('Laden fehlgeschlagen');
            }
        }

        async function saveToServer() {
            try {
                setStatus('Speichere ...');
                const resp = await fetch('/railcar/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state.items)
                });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                setStatus(`Gespeichert (${state.items.length} Eintraege)`);
            } catch (err) {
                setStatus('Speichern fehlgeschlagen');
            }
        }

        function addOrUpdate() {
            const name = nameInput.value.trim();
            if (!name) {
                setStatus('Name wird benoetigt');
                return;
            }
            const uid = uidInput.value.trim() || crypto.randomUUID();
            const existing = state.items.find(i => i.uid === uid);
            const payload = {
                uid,
                name,
                length: lengthInput.value.trim(),
                axles: axlesInput.value.trim(),
                index: indexInput.value.trim(),
                model: {
                    manufacturer: modelManufacturerInput.value.trim(),
                    scale: modelScaleSelect.value,
                    catalogNumber: modelCatalogInput.value.trim(),
                    description: modelDescriptionInput.value.trim(),
                    operator: modelOperatorInput.value.trim(),
                    className: modelClassInput.value.trim(),
                    fleetNumber: modelFleetInput.value.trim(),
                    carType: modelCarTypeSelect.value,
                    weightEmpty: modelWeightEmptyInput.value.trim(),
                    weightFull: modelWeightFullInput.value.trim(),
                    vmax: modelVmaxInput.value.trim(),
                    image: modelImageInput.value.trim(),
                    notes: modelNotesInput.value.trim()
                },
                decoder: {
                    protocol: decoderProtocolSelect.value,
                    address: decoderAddressInput.value.trim(),
                    addressType: decoderAddressTypeSelect.value,
                    functions: collectFunctionRows()
                },
                operation: {
                    purchaseDate: document.getElementById('railcar-operation-purchasedate').value.trim(),
                    operatingTime: document.getElementById('railcar-operation-operating').value.trim(),
                    travelDistance: document.getElementById('railcar-operation-travel').value.trim(),
                    serviceInterval: document.getElementById('railcar-operation-serviceinterval').value.trim(),
                    serviceIssues: collectServiceIssues()
                }
            };
            if (existing) {
                Object.assign(existing, payload);
            } else {
                state.items.push(payload);
            }
            uidInput.value = uid;
            renderList();
            state.selectedId = uid;
            addBtn.textContent = 'Aktualisieren';
            setStatus('Waggon uebernommen (nicht gespeichert)');
        }
        rowsBody.addEventListener('click', (evt) => {
            const editBtn = evt.target.closest('.otd-railcar-row-edit');
            const delBtn = evt.target.closest('.otd-railcar-row-delete');
            if (editBtn) {
                const item = state.items.find(i => i.uid === editBtn.dataset.id);
                if (item) fillForm(item);
            } else if (delBtn) {
                state.items = state.items.filter(i => i.uid !== delBtn.dataset.id);
                if (state.selectedId === delBtn.dataset.id) {
                    state.selectedId = null;
                    resetForm();
                }
                renderList();
                setStatus('Geloescht (nicht gespeichert)');
            }
        });

        rowsBody.addEventListener('dragstart', (evt) => {
            const row = evt.target.closest('tr');
            if (!row) return;
            const item = state.items.find(i => i.uid === row.dataset.id);
            if (!item) return;
            const payload = {
                type: 'railcar',
                id: item.uid,
                name: item.name,
                length: item.length,
                axles: item.axles,
                vmax: item.model?.vmax ?? ''
            };
            evt.dataTransfer?.setData('application/json', JSON.stringify(payload));
            evt.dataTransfer?.setDragImage(row, 16, 16);
        });

        async function deleteSelected() {
            if (!state.selectedId) {
                setStatus('Kein Eintrag ausgewaehlt');
                return;
            }
            state.items = state.items.filter(i => i.uid !== state.selectedId);
            state.selectedId = null;
            resetForm();
            renderList();
            setStatus('Geloescht');
            await saveToServer();
        }

        functionAddBtn?.addEventListener('click', () => {
            functionRows.appendChild(createFunctionRow());
        });
        serviceAddBtn?.addEventListener('click', () => {
            serviceIssues.appendChild(createServiceIssue());
        });

        addBtn?.addEventListener('click', addOrUpdate);
        newBtn?.addEventListener('click', () => resetForm());
        deleteBtn?.addEventListener('click', deleteSelected);
        saveBtn?.addEventListener('click', saveToServer);
        reloadBtn?.addEventListener('click', loadFromServer);
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabKey = btn.dataset.tab;
                if (tabKey) setActiveTab(tabKey);
            });
        });

        window.openWaggonFenster = function () {
            panel.classList.remove('otd-hidden');
            setActiveTab('general');
            if (!panel.style.left || !panel.style.top) {
                const workspace = document.querySelector('.otd-workspace');
                const rect = workspace?.getBoundingClientRect();
                const width = panel.offsetWidth || 980;
                const height = panel.offsetHeight || 720;
                const left = rect ? Math.max(12, (rect.width - width) / 2) : 12;
                const top = rect ? Math.max(12, (rect.height - height) / 2) : 12;
                panel.style.left = `${left}px`;
                panel.style.top = `${top}px`;
            }
            if (!state.loadedOnce) {
                loadFromServer();
            }
        };

        window.closeWaggonFenster = function () {
            panel.classList.add('otd-hidden');
        };
    })();
</script>
